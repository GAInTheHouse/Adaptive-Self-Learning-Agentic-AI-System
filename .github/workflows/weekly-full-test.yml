name: Weekly Full Test Suite

# Run comprehensive tests weekly
on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  full-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg libsndfile1
    
    - name: Install all dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html pytest-xdist
    
    - name: Run all tests in parallel
      run: |
        pytest tests/ experiments/test_*.py -v -n auto --tb=short --html=test-report.html --self-contained-html
    
    - name: Generate comprehensive coverage report
      run: |
        pytest tests/ --cov=src --cov-report=html --cov-report=term-missing --cov-report=json
    
    - name: Upload test report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test-report.html
    
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/
    
    - name: Check coverage threshold
      run: |
        COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "❌ Coverage is below 80%"
          exit 1
        else
          echo "✅ Coverage is above 80%"
        fi
    
    - name: Full test summary
      if: always()
      run: |
        echo "## Weekly Full Test Results" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "Coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY

